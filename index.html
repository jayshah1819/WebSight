<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebSight Profiler</title>
    <script src="profiler-standalone.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Courier New', monospace; 
            background: #fff; 
            color: #000; 
            padding: 15px;
            font-size: 12px;
        }
        .container { max-width: 1800px; margin: 0 auto; }
        h1 { font-size: 16px; margin-bottom: 15px; font-weight: normal; }
        h2 { font-size: 14px; margin-bottom: 10px; font-weight: normal; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        
        .box { 
            border: 1px solid #000; 
            padding: 10px; 
            background: #fff;
        }
        
        .graph-container { 
            min-height: 300px; 
            position: relative;
        }
        
        .legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #fff;
            border: 1px solid #000;
            padding: 5px;
            font-size: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }
        
        .legend-box {
            width: 15px;
            height: 10px;
            margin-right: 5px;
            border: 1px solid #000;
        }
        
        .stats { margin-bottom: 15px; }
        .stat-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 3px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .dispatch-item {
            border: 1px solid #ddd;
            padding: 5px;
            margin-bottom: 5px;
            font-size: 10px;
        }
        
        .kernel-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .kernel-box {
            border: 1px solid #000;
            padding: 8px;
        }
        
        .kernel-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 11px;
        }
        
        #profiler-status {
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #000;
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSight Profiler</h1>
        
        <div id="profiler-status">
            Status: <span id="status-text">Waiting for WebGPU app...</span><br>
            Timing Mode: <span id="timing-mode">Unknown</span><br>
            Dispatches: <span id="dispatch-count">0</span>
        </div>

        <!-- Main Performance Graphs -->
        <h2>Performance Metrics</h2>
        <div class="grid-2">
            <div class="box">
                <div class="graph-container">
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-box" style="background: #00aa00;"></div>
                            <span>GPU</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box" style="background: #000;"></div>
                            <span>CPU</span>
                        </div>
                    </div>
                    <div id="bandwidth-graph"></div>
                </div>
            </div>
            <div class="box">
                <div class="graph-container">
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-box" style="background: #00aa00;"></div>
                            <span>GPU</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box" style="background: #000;"></div>
                            <span>CPU</span>
                        </div>
                    </div>
                    <div id="time-graph"></div>
                </div>
            </div>
        </div>

        <!-- Buffer Analysis -->
        <h2>Buffer Analysis</h2>
        <div class="grid-2">
            <div class="box">
                <h2>Buffer Sizes</h2>
                <div class="legend" style="position: relative; margin-bottom: 10px;">
                    <div class="legend-item">
                        <div class="legend-box" style="background: #0066cc;"></div>
                        <span>Input</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #ff6600;"></div>
                        <span>Output</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #cc0000;"></div>
                        <span>Atomic</span>
                    </div>
                </div>
                <div id="buffer-size-graph" style="height: 250px;"></div>
            </div>
            <div class="box">
                <h2>Atomic Contention</h2>
                <div id="atomic-graph" style="height: 250px;"></div>
            </div>
        </div>

        <!-- Dispatches and Kernels -->
        <h2>Execution Details</h2>
        <div class="grid-2">
            <div class="box">
                <h2>Dispatches</h2>
                <div id="dispatch-list" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
            <div class="box">
                <h2>Kernel Performance</h2>
                <div id="kernel-list" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- Kernel Timing Graphs (Dynamic) -->
        <div id="kernel-graphs"></div>
    </div>

    <script>
        const profilerChannel = new BroadcastChannel('websight-profiler');

        // Update UI every second
        setInterval(updateUI, 1000);

        profilerChannel.onmessage = (event) => {
            if (event.data.type === 'profiler-update') {
                if (typeof WebSight !== 'undefined') {
                    const internalData = WebSight.getData();
                    Object.assign(internalData, event.data.data);
                }
            }
        };

        function updateUI() {
            if (typeof WebSight === 'undefined') return;
            
            const data = WebSight.getData();
            const stats = WebSight.getStats();
            const sessionInfo = WebSight.getSessionInfo();
            
            // Update status
            document.getElementById('status-text').textContent = 
                data.dispatches.length > 0 ? 'Active' : 'Waiting';
            document.getElementById('timing-mode').textContent = sessionInfo.timingMode;
            document.getElementById('dispatch-count').textContent = data.dispatches.length;
            
            if (data.dispatches.length === 0) return;
            
            // Prepare data
            const dispatches = data.dispatches;
            const inputBytes = dispatches.map(d => {
                const buffers = d.bufferAccesses || [];
                return buffers.reduce((sum, b) => sum + (b.size || 0), 0);
            });
            
            const gpuTimes = dispatches.map(d => d.gpuTime || 0);
            const cpuTimes = dispatches.map(d => ((d.cpuEnd || 0) - (d.cpuStart || 0)) * 1000);
            
            // Calculate bandwidth (bytes/time)
            const gpuBandwidth = dispatches.map((d, i) => {
                const bytes = inputBytes[i];
                const time = gpuTimes[i] / 1000000; // us to s
                return time > 0 ? (bytes / time) / 1e9 : 0; // GB/s
            });
            
            const cpuBandwidth = dispatches.map((d, i) => {
                const bytes = inputBytes[i];
                const time = cpuTimes[i] / 1000000;
                return time > 0 ? (bytes / time) / 1e9 : 0;
            });
            
            // Plot Bandwidth
            plotGraph('bandwidth-graph', 
                [
                    {
                        x: inputBytes,
                        y: gpuBandwidth,
                        name: 'GPU',
                        line: { color: '#00aa00', width: 2 }
                    },
                    {
                        x: inputBytes,
                        y: cpuBandwidth,
                        name: 'CPU',
                        line: { color: '#000000', width: 2 }
                    }
                ],
                'Input array size (B)',
                'Achieved bandwidth (GB/s)'
            );
            
            // Plot Time
            plotGraph('time-graph',
                [
                    {
                        x: inputBytes,
                        y: gpuTimes,
                        name: 'GPU',
                        line: { color: '#00aa00', width: 2 }
                    },
                    {
                        x: inputBytes,
                        y: cpuTimes,
                        name: 'CPU',
                        line: { color: '#000000', width: 2 }
                    }
                ],
                'Input array size (B)',
                'Time (μs)'
            );
            
            // Buffer Size Graph
            plotBufferSizes(data.buffers);
            
            // Atomic Contention Graph
            plotAtomicContention(dispatches);
            
            // Update Dispatch List
            updateDispatchList(dispatches);
            
            // Update Kernel List
            updateKernelList(data.kernels);
            
            // Update Kernel Graphs
            updateKernelGraphs(data);
        }

        function plotGraph(divId, traces, xLabel, yLabel) {
            // Filter out zero/invalid values for log scale
            const cleanedTraces = traces.map(t => {
                const validIndices = t.y.map((v, i) => v > 0 && t.x[i] > 0 ? i : -1).filter(i => i !== -1);
                return {
                    x: validIndices.map(i => t.x[i]),
                    y: validIndices.map(i => t.y[i]),
                    name: t.name,
                    line: t.line,
                    marker: { color: t.line.color }
                };
            });

            const layout = {
                xaxis: {
                    title: { text: xLabel, font: { size: 11 } },
                    type: 'log',
                    gridcolor: '#e0e0e0',
                    showline: true,
                    linecolor: '#000',
                    linewidth: 1,
                    showgrid: true,
                    zeroline: false,
                    tickfont: { size: 9 }
                },
                yaxis: {
                    title: { text: yLabel, font: { size: 11 } },
                    type: 'log',
                    gridcolor: '#e0e0e0',
                    showline: true,
                    linecolor: '#000',
                    linewidth: 1,
                    showgrid: true,
                    zeroline: false,
                    tickfont: { size: 9 }
                },
                showlegend: false,
                margin: { l: 70, r: 20, t: 20, b: 60 },
                plot_bgcolor: '#fff',
                paper_bgcolor: '#fff',
                font: { family: 'Courier New', size: 10 }
            };
            
            Plotly.newPlot(divId, cleanedTraces.map(t => ({
                x: t.x,
                y: t.y,
                type: 'scatter',
                mode: 'lines+markers',
                marker: { size: 5, color: t.line.color },
                line: { width: 2, color: t.line.color },
                name: t.name
            })), layout, {
                displayModeBar: false,
                responsive: true
            });
        }

        function plotBufferSizes(buffers) {
            const bufferArray = Object.values(buffers);
            if (bufferArray.length === 0) {
                document.getElementById('buffer-size-graph').innerHTML = '<div style="padding:20px;">No buffers</div>';
                return;
            }
            
            const input = [], output = [], atomic = [], labels = [];
            
            bufferArray.forEach((b, i) => {
                labels.push(b.label || `Buffer ${i}`);
                const sizeMB = b.size / (1024 * 1024);
                const isInput = (b.usage & 0x0080) && (b.usage & 0x0008);
                const isOutput = (b.usage & 0x0080) && (b.usage & 0x0004);
                const isAtomic = b.label.toLowerCase().includes('atomic');
                
                input.push(isInput && !isAtomic ? sizeMB : 0);
                output.push(isOutput && !isAtomic ? sizeMB : 0);
                atomic.push(isAtomic ? sizeMB : 0);
            });
            
            const traces = [
                { x: labels, y: input, name: 'Input', type: 'bar', marker: { color: '#0066cc' } },
                { x: labels, y: output, name: 'Output', type: 'bar', marker: { color: '#ff6600' } },
                { x: labels, y: atomic, name: 'Atomic', type: 'bar', marker: { color: '#cc0000' } }
            ];
            
            Plotly.newPlot('buffer-size-graph', traces, {
                barmode: 'stack',
                showlegend: false,
                xaxis: { title: 'Buffer', tickangle: -45 },
                yaxis: { title: 'Size (MB)' },
                margin: { l: 50, r: 20, t: 20, b: 100 },
                font: { family: 'Courier New', size: 9 }
            }, { displayModeBar: false, responsive: true });
        }

        function plotAtomicContention(dispatches) {
            const x = [], y = [];
            
            dispatches.forEach((d, i) => {
                const atomicBuffers = (d.bufferAccesses || []).filter(b => 
                    b.label && b.label.toLowerCase().includes('atomic')
                );
                
                if (atomicBuffers.length > 0) {
                    const totalThreads = d.x * d.y * d.z;
                    const bins = atomicBuffers[0].size / 4;
                    x.push(i);
                    y.push(totalThreads / bins);
                }
            });
            
            if (x.length === 0) {
                document.getElementById('atomic-graph').innerHTML = 
                    '<div style="padding: 20px; text-align: center; color: #666;">No atomic operations detected</div>';
                return;
            }
            
            Plotly.newPlot('atomic-graph', [{
                x, y, type: 'scatter', mode: 'lines+markers',
                line: { color: '#ff6600', width: 2 }, marker: { size: 4, color: '#ff6600' }
            }], {
                xaxis: { title: 'Dispatch Index' },
                yaxis: { title: 'Threads per Bin' },
                margin: { l: 60, r: 20, t: 20, b: 50 },
                font: { family: 'Courier New', size: 10 }
            }, { displayModeBar: false, responsive: true });
        }

        function updateDispatchList(dispatches) {
            const div = document.getElementById('dispatch-list');
            const recent = dispatches.slice(-20).reverse();
            
            div.innerHTML = recent.map(d => `
                <div class="dispatch-item">
                    <strong>Dispatch ${d.index}</strong>: ${d.pipelineLabel}<br>
                    Workgroups: ${d.x}×${d.y}×${d.z}<br>
                    GPU Time: ${d.gpuTime ? d.gpuTime.toFixed(2) + ' μs' : 'N/A'}<br>
                    Source: ${d.timingSource || 'unknown'}
                </div>
            `).join('');
        }

        function updateKernelList(kernels) {
            const div = document.getElementById('kernel-list');
            const kernelArray = Object.values(kernels);
            
            if (kernelArray.length === 0) {
                div.innerHTML = '<div style="padding: 20px; color: #666;">No kernels detected</div>';
                return;
            }
            
            div.innerHTML = kernelArray.map(k => `
                <div class="dispatch-item">
                    <strong>${k.label}</strong><br>
                    Dispatches: ${k.stats?.count || 0}<br>
                    Avg Time: ${k.stats?.avgTime ? k.stats.avgTime.toFixed(2) + ' μs' : 'N/A'}<br>
                    Total Time: ${k.stats?.totalTime ? (k.stats.totalTime / 1000).toFixed(2) + ' ms' : 'N/A'}
                </div>
            `).join('');
        }

        function updateKernelGraphs(data) {
            const kernels = Object.values(data.kernels);
            const div = document.getElementById('kernel-graphs');
            
            if (kernels.length === 0) return;
            
            const gridClass = kernels.length <= 2 ? 'grid-2' : 'kernel-grid';
            div.innerHTML = `<h2>Kernel Timing</h2><div class="${gridClass}" id="kernel-grid-container"></div>`;
            
            const container = document.getElementById('kernel-grid-container');
            
            kernels.forEach((kernel, idx) => {
                const dispatches = data.dispatches.filter(d => d.kernelId === kernel.id);
                if (dispatches.length === 0) return;
                
                const boxDiv = document.createElement('div');
                boxDiv.className = 'box';
                boxDiv.innerHTML = `
                    <div class="kernel-title">${kernel.label}</div>
                    <div id="kernel-graph-${idx}" style="height: 200px;"></div>
                `;
                container.appendChild(boxDiv);
                
                const x = dispatches.map((d, i) => i);
                const y = dispatches.map(d => d.gpuTime || 0);
                
                setTimeout(() => {
                    Plotly.newPlot(`kernel-graph-${idx}`, [{
                        x, y, type: 'scatter', mode: 'lines',
                        line: { color: '#000', width: 1 }
                    }], {
                        xaxis: { title: 'Dispatch #' },
                        yaxis: { title: 'Time (μs)' },
                        margin: { l: 50, r: 20, t: 20, b: 40 },
                        font: { family: 'Courier New', size: 9 }
                    }, { displayModeBar: false, responsive: true });
                }, 100);
            });
        }

        // Start monitoring
        if (typeof WebSight !== 'undefined') {
            WebSight.start();
        }
        updateUI();
    </script>
</body>
</html>
